<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kony Admin - Debug Mode</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 0;
            background: #f8fafc;
        }
        
        .debug-container {
            max-width: 800px;
            margin: 2rem auto;
            padding: 2rem;
            background: white;
            border-radius: 1rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .status {
            padding: 1rem;
            margin: 1rem 0;
            border-radius: 0.5rem;
            border-left: 4px solid;
        }
        
        .status.loading { background: #eff6ff; border-color: #3b82f6; color: #1e40af; }
        .status.success { background: #f0fdf4; border-color: #16a34a; color: #15803d; }
        .status.error { background: #fef2f2; border-color: #dc2626; color: #dc2626; }
        .status.warning { background: #fffbeb; border-color: #f59e0b; color: #d97706; }
        
        button {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 0.375rem;
            cursor: pointer;
            margin: 0.5rem;
            font-weight: 500;
        }
        
        button:hover {
            background: #2563eb;
        }
        
        button.danger {
            background: #dc2626;
        }
        
        button.success {
            background: #16a34a;
        }
        
        pre {
            background: #f3f4f6;
            padding: 1rem;
            border-radius: 0.5rem;
            overflow-x: auto;
            font-size: 0.875rem;
        }
        
        .spinner {
            display: inline-block;
            width: 1rem;
            height: 1rem;
            border: 2px solid #e5e7eb;
            border-top: 2px solid #3b82f6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 0.5rem;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .console-output {
            background: #1f2937;
            color: #f9fafb;
            padding: 1rem;
            border-radius: 0.5rem;
            font-family: 'Courier New', monospace;
            font-size: 0.875rem;
            max-height: 300px;
            overflow-y: auto;
            margin: 1rem 0;
        }
        
        .test-section {
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            padding: 1rem;
            margin: 1rem 0;
        }
    </style>
</head>
<body>
    <div class="debug-container">
        <h1><i class="bi bi-bug"></i> Kony Admin - Debug Mode</h1>
        <p>This page will help us diagnose why the application is stuck loading.</p>
        
        <div id="console-output" class="console-output">
            <div>üöÄ Debug console initialized...</div>
        </div>
        
        <div class="test-section">
            <h3>Step 1: Basic Tests</h3>
            <button onclick="testBasics()">üîç Run Basic Tests</button>
            <div id="basic-results"></div>
        </div>
        
        <div class="test-section">
            <h3>Step 2: Firebase Connection</h3>
            <button onclick="testFirebase()">üî• Test Firebase</button>
            <div id="firebase-results"></div>
        </div>
        
        <div class="test-section">
            <h3>Step 3: Authentication</h3>
            <button onclick="testAuth()">üîë Test Authentication</button>
            <div id="auth-results"></div>
        </div>
        
        <div class="test-section">
            <h3>Step 4: Load Dashboard</h3>
            <button onclick="loadDashboard()" class="success">üìä Load BI Dashboard</button>
            <button onclick="loadDashboardWithMockData()" class="success">üìä Load with Mock Data</button>
            <div id="dashboard-results"></div>
        </div>
        
        <div class="test-section">
            <h3>Emergency Options</h3>
            <button onclick="bypassAuth()" class="danger">‚ö†Ô∏è Bypass Authentication</button>
            <button onclick="showMockDashboard()" class="success">üéØ Show Mock Dashboard</button>
        </div>
    </div>

    <script type="module">
        // Console logging to page
        function log(message, type = 'info') {
            const output = document.getElementById('console-output');
            const timestamp = new Date().toLocaleTimeString();
            const icon = type === 'error' ? '‚ùå' : type === 'success' ? '‚úÖ' : type === 'warning' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è';
            output.innerHTML += `<div>${timestamp} ${icon} ${message}</div>`;
            output.scrollTop = output.scrollHeight;
            console.log(message);
        }
        
        function showStatus(containerId, message, type = 'loading') {
            const container = document.getElementById(containerId);
            const spinner = type === 'loading' ? '<span class="spinner"></span>' : '';
            container.innerHTML = `<div class="status ${type}">${spinner}${message}</div>`;
        }
        
        // Test functions
        window.testBasics = function() {
            log('üîç Starting basic tests...');
            showStatus('basic-results', 'Running basic tests...', 'loading');
            
            try {
                // Test 1: Check if we can access basic DOM
                log('‚úÖ DOM access: OK');
                
                // Test 2: Check if modules are supported
                log('‚úÖ ES6 Modules: Supported');
                
                // Test 3: Check console access
                log('‚úÖ Console access: OK');
                
                // Test 4: Check local storage
                try {
                    localStorage.setItem('test', 'value');
                    localStorage.removeItem('test');
                    log('‚úÖ Local Storage: OK');
                } catch(e) {
                    log('‚ùå Local Storage: Failed - ' + e.message, 'error');
                }
                
                // Test 5: Check network access
                fetch('https://www.google.com/favicon.ico', { mode: 'no-cors' })
                    .then(() => log('‚úÖ Network access: OK'))
                    .catch(() => log('‚ùå Network access: Failed', 'warning'));
                
                showStatus('basic-results', 'Basic tests completed successfully', 'success');
                
            } catch(error) {
                log('‚ùå Basic tests failed: ' + error.message, 'error');
                showStatus('basic-results', 'Basic tests failed: ' + error.message, 'error');
            }
        };
        
        window.testFirebase = async function() {
            log('üî• Testing Firebase connection...');
            showStatus('firebase-results', 'Testing Firebase connection...', 'loading');
            
            try {
                // Try to import Firebase
                const { initializeApp } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js');
                const { getFirestore } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
                const { getAuth } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js');
                
                log('‚úÖ Firebase modules imported successfully');
                
                // Try to initialize with your config
                const firebaseConfig = {
                    apiKey: "AIzaSyA_i_snqrJHccBp2qpMLhFfhyRVwBoJ7z0",
                    authDomain: "kony-25092.firebaseapp.com",
                    projectId: "kony-25092",
                    storageBucket: "kony-25092.firebasestorage.app",
                    messagingSenderId: "373594331946",
                    appId: "1:373594331946:web:20c17dfa80cdba1bcd9c53",
                    measurementId: "G-QE6LX3NEDT"
                };
                
                const app = initializeApp(firebaseConfig);
                const db = getFirestore(app);
                const auth = getAuth(app);
                
                log('‚úÖ Firebase initialized successfully');
                log('‚úÖ Auth object created: ' + !!auth);
                log('‚úÖ Firestore object created: ' + !!db);
                
                // Store for other tests
                window.testFirebaseApp = { app, db, auth };
                
                showStatus('firebase-results', 'Firebase connection successful', 'success');
                
            } catch(error) {
                log('‚ùå Firebase test failed: ' + error.message, 'error');
                showStatus('firebase-results', 'Firebase failed: ' + error.message, 'error');
            }
        };
        
        window.testAuth = async function() {
            log('üîë Testing authentication...');
            showStatus('auth-results', 'Testing authentication...', 'loading');
            
            if (!window.testFirebaseApp) {
                showStatus('auth-results', 'Run Firebase test first', 'warning');
                return;
            }
            
            try {
                const { onAuthStateChanged } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js');
                const { auth } = window.testFirebaseApp;
                
                log('üîç Setting up auth state listener...');
                
                const timeout = setTimeout(() => {
                    log('‚ö†Ô∏è Auth timeout after 5 seconds', 'warning');
                    showStatus('auth-results', 'Authentication timeout - this might be normal', 'warning');
                }, 5000);
                
                onAuthStateChanged(auth, (user) => {
                    clearTimeout(timeout);
                    if (user) {
                        log('‚úÖ User is signed in: ' + user.email);
                        showStatus('auth-results', 'User authenticated: ' + user.email, 'success');
                    } else {
                        log('‚ÑπÔ∏è No user signed in (this is normal)');
                        showStatus('auth-results', 'No user signed in - ready for login', 'success');
                    }
                });
                
            } catch(error) {
                log('‚ùå Auth test failed: ' + error.message, 'error');
                showStatus('auth-results', 'Auth test failed: ' + error.message, 'error');
            }
        };
        
        window.loadDashboard = async function() {
            log('üìä Loading BI Dashboard...');
            showStatus('dashboard-results', 'Loading dashboard...', 'loading');
            
            try {
                // Clear the page and show dashboard
                document.body.innerHTML = `
                    <div style="padding: 2rem;">
                        <h1>üöß Loading BI Dashboard...</h1>
                        <p>If this works, we'll implement the full dashboard.</p>
                        <button onclick="window.location.reload()">‚Üê Back to Debug</button>
                    </div>
                `;
                
                // Try to load your actual dashboard
                const { initializeBIDashboard } = await import('./src/dashboard.js');
                const container = document.createElement('div');
                document.body.appendChild(container);
                initializeBIDashboard(container);
                
            } catch(error) {
                log('‚ùå Dashboard load failed: ' + error.message, 'error');
                document.body.innerHTML = `
                    <div style="padding: 2rem;">
                        <h1>‚ùå Dashboard Load Failed</h1>
                        <pre>${error.message}</pre>
                        <button onclick="window.location.reload()">‚Üê Back to Debug</button>
                    </div>
                `;
            }
        };
        
        window.loadDashboardWithMockData = function() {
            log('üìä Loading Dashboard with Mock Data...');
            
            // Create a simple mock dashboard
            document.body.innerHTML = `
                <div style="font-family: Arial, sans-serif; padding: 2rem; background: #f8fafc; min-height: 100vh;">
                    <div style="max-width: 1200px; margin: 0 auto;">
                        <h1 style="color: #1f2937; margin-bottom: 2rem;">
                            <i class="bi bi-graph-up-arrow"></i> Kony BI Dashboard (Mock)
                        </h1>
                        
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
                            <div style="background: white; padding: 1.5rem; border-radius: 0.5rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                                <h3 style="color: #3b82f6; margin: 0 0 0.5rem 0;">üìä Total Reports</h3>
                                <div style="font-size: 2rem; font-weight: bold; color: #1f2937;">147</div>
                            </div>
                            <div style="background: white; padding: 1.5rem; border-radius: 0.5rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                                <h3 style="color: #16a34a; margin: 0 0 0.5rem 0;">‚úÖ Approved</h3>
                                <div style="font-size: 2rem; font-weight: bold; color: #1f2937;">89</div>
                            </div>
                            <div style="background: white; padding: 1.5rem; border-radius: 0.5rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                                <h3 style="color: #f59e0b; margin: 0 0 0.5rem 0;">üë• Technicians</h3>
                                <div style="font-size: 2rem; font-weight: bold; color: #1f2937;">12</div>
                            </div>
                            <div style="background: white; padding: 1.5rem; border-radius: 0.5rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                                <h3 style="color: #8b5cf6; margin: 0 0 0.5rem 0;">üè¢ Clients</h3>
                                <div style="font-size: 2rem; font-weight: bold; color: #1f2937;">28</div>
                            </div>
                        </div>
                        
                        <div style="background: white; padding: 1.5rem; border-radius: 0.5rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 2rem;">
                            <h3 style="color: #1f2937; margin: 0 0 1rem 0;">üìà Recent Activity</h3>
                            <div style="color: #6b7280;">
                                <p>‚úÖ Report #147 approved by Skander Sellami</p>
                                <p>üìù Report #146 submitted by Ahmed Ben Salem</p>
                                <p>üîç Report #145 under review</p>
                                <p>üìä New technician added: Fatima Zahra</p>
                            </div>
                        </div>
                        
                        <div style="text-align: center;">
                            <button onclick="window.location.reload()" style="background: #3b82f6; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 0.375rem; cursor: pointer;">
                                ‚Üê Back to Debug Mode
                            </button>
                        </div>
                    </div>
                </div>
            `;
        };
        
        window.bypassAuth = function() {
            log('‚ö†Ô∏è Bypassing authentication...');
            
            // Show a simple admin interface
            document.body.innerHTML = `
                <div style="font-family: Arial, sans-serif; padding: 2rem; background: #f8fafc; min-height: 100vh;">
                    <div style="max-width: 600px; margin: 0 auto; text-align: center;">
                        <h1 style="color: #dc2626;">‚ö†Ô∏è Emergency Access Mode</h1>
                        <p style="color: #6b7280; margin-bottom: 2rem;">Authentication bypassed for debugging purposes.</p>
                        
                        <div style="background: white; padding: 2rem; border-radius: 0.5rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 2rem;">
                            <h3>What would you like to do?</h3>
                            <button onclick="loadDashboardWithMockData()" style="background: #16a34a; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 0.375rem; cursor: pointer; margin: 0.5rem;">
                                üìä View Mock Dashboard
                            </button>
                            <br>
                            <button onclick="showLoginForm()" style="background: #3b82f6; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 0.375rem; cursor: pointer; margin: 0.5rem;">
                                üîë Try Manual Login
                            </button>
                        </div>
                        
                        <button onclick="window.location.reload()" style="background: #6b7280; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 0.375rem; cursor: pointer;">
                            ‚Üê Back to Debug
                        </button>
                    </div>
                </div>
            `;
        };
        
        window.showLoginForm = function() {
            document.body.innerHTML = `
                <div style="font-family: Arial, sans-serif; background: #f8fafc; min-height: 100vh; display: flex; align-items: center; justify-content: center;">
                    <div style="background: white; padding: 2rem; border-radius: 1rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1); width: 100%; max-width: 400px;">
                        <h2 style="text-align: center; color: #1f2937; margin-bottom: 1.5rem;">
                            üîë Kony Admin Login
                        </h2>
                        <form onsubmit="handleLogin(event)">
                            <div style="margin-bottom: 1rem;">
                                <label style="display: block; margin-bottom: 0.5rem; color: #374151;">Email</label>
                                <input type="email" id="email" value="skander.cars139@gmail.com" style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 0.375rem;">
                            </div>
                            <div style="margin-bottom: 1.5rem;">
                                <label style="display: block; margin-bottom: 0.5rem; color: #374151;">Password</label>
                                <input type="password" id="password" value="skander1234" style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 0.375rem;">
                            </div>
                            <button type="submit" style="width: 100%; background: #3b82f6; color: white; border: none; padding: 0.75rem; border-radius: 0.375rem; cursor: pointer; margin-bottom: 1rem;">
                                Sign In
                            </button>
                        </form>
                        <button onclick="window.location.reload()" style="width: 100%; background: #6b7280; color: white; border: none; padding: 0.75rem; border-radius: 0.375rem; cursor: pointer;">
                            ‚Üê Back to Debug
                        </button>
                    </div>
                </div>
            `;
        };
        
        window.handleLogin = async function(event) {
            event.preventDefault();
            
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            
            try {
                if (!window.testFirebaseApp) {
                    alert('Firebase not initialized. Run Firebase test first.');
                    return;
                }
                
                const { signInWithEmailAndPassword } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js');
                const { auth } = window.testFirebaseApp;
                
                const userCredential = await signInWithEmailAndPassword(auth, email, password);
                alert('Login successful! User: ' + userCredential.user.email);
                
                // Try to load dashboard
                loadDashboardWithMockData();
                
            } catch (error) {
                alert('Login failed: ' + error.message);
            }
        };
        
        window.showMockDashboard = loadDashboardWithMockData;
        
        // Auto-run basic tests
        log('üéØ Debug page loaded successfully');
        log('Click the buttons above to run tests step by step');
        
    </script>
</body>
</html>